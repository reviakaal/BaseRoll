name: Deploy BaseRoll
on:
  workflow_dispatch:
    inputs:
      network:
        description: "Target network (base or baseSepolia)"
        required: true
        default: "baseSepolia"
      minBalanceEth:
        description: "Minimum ETH required on selected network"
        required: true
        default: "0.0001"
      skipBalanceCheck:
        description: "Skip balance check (true/false)"
        required: true
        default: "false"
      verify:
        description: "Verify on BaseScan (true/false)"
        required: true
        default: "true"
jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
      BASE_MAINNET_RPC_URL: ${{ secrets.BASE_MAINNET_RPC_URL }}
      BASE_SEPOLIA_RPC_URL: ${{ secrets.BASE_SEPOLIA_RPC_URL }}
      BASESCAN_API_KEY: ${{ secrets.BASESCAN_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm install --no-audit --no-fund
      - name: Preflight balance check
        if: ${{ github.event.inputs.skipBalanceCheck != 'true' }}
        run: |
          node scripts/check-balance.js "${{ github.event.inputs.network }}" "${{ github.event.inputs.minBalanceEth }}"
      - name: Build
        run: npm run build --if-present
      - name: Deploy
        run: |
          if [ "${{ github.event.inputs.network }}" = "base" ]; then
            npx hardhat run scripts/deploy.js --network base
          else
            npx hardhat run scripts/deploy.js --network baseSepolia
          fi
      - name: Print Proxy & Impl from logs
        run: echo "Deployment done. See previous step for addresses."
      - name: Verify (implementation)
        if: ${{ github.event.inputs.verify == 'true' }}
        run: |
          echo "To verify locally: npx hardhat verify --network ${{ github.event.inputs.network }} <IMPLEMENTATION_ADDRESS>"
